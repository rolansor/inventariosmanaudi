{% extends 'base.html' %}

{% block title %}Manejo de Categorías{% endblock %}

{% block encabezado %}
<!-- BEGIN breadcrumb -->
<ol class="breadcrumb float-xl-end">
    <li class="breadcrumb-item"><a href="javascript:;">Inicio</a></li>
    <li class="breadcrumb-item active">Manejo de Categorías</li>
</ol>
<!-- END breadcrumb -->
<!-- BEGIN page-header -->
<h1 class="page-header">Manejo de Categorías</h1>
<!-- END page-header -->
{% endblock %}

{% block contenido %}
    <div class="panel panel-inverse">
        <div class="panel-heading">
            <h4 class="panel-title">Nueva Categoría</h4>
        </div>
        <div class="panel-body">
            <form method="POST" id="categoria-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="nombre">Nombre</label>
                    <input type="text" class="form-control" id="nombre" name="nombre" value="">
                </div>
                <br>
                <button type="submit" class="btn btn-primary" id="submit-btn">Crear</button>
            </form>
        </div>
    </div>
    <div class="panel panel-inverse">
        <div class="panel-heading">
            <h4 class="panel-title">Lista de Categorías</h4>
        </div>
        <div class="panel-body">
            <table class="table table-striped table-bordered" id="categoria-list">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Nombre</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody>
                {% for categoria in categorias %}
                    <tr id="categoria-{{ categoria.pk }}">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ categoria.nombre }}</td>
                        <td>
                            <button class="btn btn-primary edit-categoria" data-id="{{ categoria.pk }}">Editar</button>
                            <a href="{% url 'subcategoria_list' categoria.pk %}" class="btn btn-warning">Subcategorias</a>
                            <button class="btn btn-danger delete-categoria" data-id="{{ categoria.pk }}">Eliminar</button>
                        </td>
                    </tr>
                {% empty %}
                <tr>
                    <td colspan="3" class="text-center">No hay categorías registradas.</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Crear o actualizar categoría con Ajax
    $('#categoria-form').on('submit', function (event) {
        event.preventDefault();
        var formData = $(this).serialize();
        var url = $('#submit-btn').data('url');

        $.ajax({
            url: url,
            type: 'POST',
            data: formData,
            success: function (response) {
                var row = $('#categoria-' + response.id);
                if (row.length) {
                    row.find('td:eq(1)').text(response.nombre);
                } else {
                    $('#categoria-list tbody').append(`
                        <tr id="categoria-${response.id}">
                            <td>${$('#categoria-list tbody tr').length + 1}</td>
                            <td>${response.nombre}</td>
                            <td>
                                <button class="btn btn-primary edit-categoria" data-id="${response.id}">Editar</button>
                                <a href="/inventario/categorias/${response.id}/subcategorias" class="btn btn-warning">Subcategorias</a>
                                <button class="btn btn-danger delete-categoria" data-id="${response.id}">Eliminar</button>
                            </td>
                        </tr>
                    `);
                }

                $('#categoria-form').trigger('reset');
                $('#submit-btn').text('Crear').data('url', '/inventario/categorias/');
            },
            error: function (xhr, status, error) {
                alert('Error al procesar la solicitud: ' + error);
            }
        });
    });

    // Manejar la edición de categoría
    $('#categoria-list').on('click', '.edit-categoria', function () {
        var categoriaId = $(this).data('id');
        $.ajax({
            url: '/inventario/categorias/editar/' + categoriaId + '/',
            type: 'GET',
            success: function (response) {
                $('#nombre').val(response.nombre);
                $('#submit-btn').text('Actualizar').data('url', '/inventario/categorias/editar/' + categoriaId + '/');
            },
            error: function (xhr, status, error) {
                alert('Error al cargar la categoría: ' + error);
            }
        });
    });

    // Manejar la eliminación de categoría
    $('#categoria-list').on('click', '.delete-categoria', function () {
        var categoriaId = $(this).data('id');
        if (confirm('¿Estás seguro de que deseas eliminar esta categoría?')) {
            $.ajax({
                url: '/inventario/categorias/eliminar/' + categoriaId + '/',
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (response) {
                    $('#categoria-' + categoriaId).remove();
                },
                error: function (xhr, status, error) {
                    alert('Error al eliminar la categoría: ' + error);
                }
            });
        }
    });
</script>
{% endblock %}
