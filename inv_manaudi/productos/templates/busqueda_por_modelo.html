{% extends 'base.html' %}
{% load static %}

{% block title %}Búsqueda por Modelo{% endblock %}

{% block extra_css %}
    <link href="{% static 'plugins/datatables.net-bs5/css/dataTables.bootstrap5.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'plugins/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'plugins/datatables.net-buttons-bs5/css/buttons.bootstrap5.min.css' %}" rel="stylesheet"/>
{% endblock %}

{% block encabezado %}
<ol class="breadcrumb float-xl-end">
    <li class="breadcrumb-item"><a href="{% url 'inicio' %}">Inicio</a></li>
    <li class="breadcrumb-item active">Búsqueda por Modelo</li>
</ol>
<h1 class="page-header">Búsqueda por Modelo de Producto</h1>
{% endblock %}

{% block contenido %}
<div class="panel panel-inverse">
    <div class="panel-heading">
        <h4 class="panel-title">Búsqueda por Modelo de Producto Óptica</h4>
    </div>
    <div class="panel-body">
        <!-- Formulario de búsqueda -->
        <form method="GET" class="mb-4">
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group">
                        <label for="modelo" class="form-label">Modelo del Producto:</label>
                        <input type="text" 
                               class="form-control" 
                               id="modelo" 
                               name="modelo" 
                               value="{{ modelo_buscado }}" 
                               placeholder="Ingrese el modelo a buscar (ej: RB3025, VO5239)"
                               style="text-transform: uppercase;"
                               oninput="this.value = this.value.toUpperCase()">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-search"></i> Buscar
                            </button>
                            {% if modelo_buscado %}
                            <a href="{% url 'busqueda_por_modelo' %}" class="btn btn-secondary">
                                <i class="fa fa-times"></i> Limpiar
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </form>

        {% if modelo_buscado %}
            <div class="alert alert-info">
                <strong>Búsqueda:</strong> Resultados para el modelo "<strong>{{ modelo_buscado }}</strong>"
                {% if productos %}
                    - Se encontraron {{ productos|length }} producto(s)
                {% else %}
                    - No se encontraron productos
                {% endif %}
            </div>
        {% endif %}

        {% if productos %}
        <div class="table-responsive">
            <table id="tabla-productos" class="table table-striped table-bordered align-middle text-nowrap">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Marca</th>
                        <th>Modelo</th>
                        <th>Línea</th>
                        <th>Sublínea</th>
                        <th>Clase</th>
                        <th>Precio</th>
                        <th>Material</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                {% for producto in productos %}
                    <tr>
                        <td><span class="badge bg-primary">{{ producto.codigo }}</span></td>
                        <td><strong>{{ producto.marca|upper }}</strong></td>
                        <td><strong class="text-success">{{ producto.modelo|upper }}</strong></td>
                        <td>{{ producto.get_linea_display|upper }}</td>
                        <td>{{ producto.get_sublinea_display|upper }}</td>
                        <td>{{ producto.get_clase_display|upper }}</td>
                        <td>${{ producto.precio }}</td>
                        <td>{{ producto.get_material_display|upper|default:"-" }}</td>
                        <td>
                            {% if producto.estado == 'activo' %}
                                <span class="badge bg-success">ACTIVO</span>
                            {% else %}
                                <span class="badge bg-danger">INACTIVO</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'editar_producto' producto.pk %}" class="btn btn-sm btn-primary" title="Editar">
                                <i class="fa fa-edit"></i>
                            </a>
                            {% if producto.estado == 'activo' %}
                                <a href="{% url 'eliminar_producto' producto.pk %}" class="btn btn-sm btn-warning" 
                                   onclick="return confirm('¿Desactivar este producto?')" title="Desactivar">
                                    <i class="fa fa-ban"></i>
                                </a>
                            {% else %}
                                <a href="{% url 'activar_producto' producto.pk %}" class="btn btn-sm btn-success"
                                   onclick="return confirm('¿Activar este producto?')" title="Activar">
                                    <i class="fa fa-check"></i>
                                </a>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% elif modelo_buscado %}
            <div class="alert alert-warning">
                <h5><i class="fa fa-exclamation-triangle"></i> No se encontraron resultados</h5>
                <p>No se encontraron productos con el modelo "<strong>{{ modelo_buscado }}</strong>".</p>
                <p>Sugerencias:</p>
                <ul>
                    <li>Verifique que el modelo esté escrito correctamente</li>
                    <li>Intente con parte del modelo (ej: "RB" en lugar de "RB3025")</li>
                    <li>Revise la <a href="{% url 'lista_productos' %}">lista completa de productos</a></li>
                </ul>
            </div>
        {% else %}
            <div class="alert alert-light">
                <h5><i class="fa fa-info-circle"></i> Búsqueda por Modelo</h5>
                <p>Ingrese el modelo del producto que desea buscar en el campo de arriba.</p>
                <p><strong>Ejemplos de modelos:</strong></p>
                <div class="row">
                    <div class="col-md-6">
                        <ul>
                            <li><code>RB3025</code> - Ray-Ban Aviador</li>
                            <li><code>VO5239</code> - Vogue Cat Eye</li>
                            <li><code>OX8046</code> - Oakley Deportivo</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul>
                            <li><code>PR17WS</code> - Prada Ejecutivo</li>
                            <li><code>CH5380</code> - Chanel Glamour</li>
                            <li><code>TF5634</code> - Tom Ford Luxury</li>
                        </ul>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
    {% if productos %}
    <script src="{% static 'plugins/datatables.net/js/dataTables.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-responsive/js/dataTables.responsive.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/dataTables.buttons.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.colVis.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.html5.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.print.js' %}"></script>
    <script src="{% static 'plugins/pdfmake/build/pdfmake.js' %}"></script>
    <script src="{% static 'plugins/pdfmake/build/vfs_fonts.js' %}"></script>
    <script src="{% static 'plugins/jszip/dist/jszip.js' %}"></script>
    <script>
        $(document).ready(function () {
            $('#tabla-productos').DataTable({
                dom: '<"row mb-3"<"col-md-6"B><"col-md-6"fr>>t<"row mt-3"<"col-md-auto me-md-auto"i><"col-md-auto ms-md-auto"p>>',
                buttons: [
                    { extend: 'copy', className: 'btn-sm' },
                    { extend: 'csv', className: 'btn-sm' },
                    { extend: 'excel', className: 'btn-sm' },
                    { extend: 'pdf', className: 'btn-sm' },
                    { extend: 'print', className: 'btn-sm' }
                ],
                responsive: true,
                pageLength: 25,
                lengthMenu: [25, 50, 100, 200],
                language: {
                    "lengthMenu": "Mostrar _MENU_ entradas",
                    "zeroRecords": "No se encontraron registros",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                    "infoEmpty": "Mostrando 0 a 0 de 0 entradas",
                    "infoFiltered": "(filtrado de _MAX_ entradas totales)",
                    "search": "Buscar:",
                    "paginate": {
                        "first": "Primero",
                        "last": "Último",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    },
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "emptyTable": "No hay datos disponibles en la tabla"
                }
            });
        });
    </script>
    {% endif %}
{% endblock %}