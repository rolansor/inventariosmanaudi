{% extends 'base.html' %}
{% load static %}

{% block title %}Editar Producto{% endblock %}

{% block encabezado %}
    <ol class="breadcrumb float-xl-end">
        <li class="breadcrumb-item"><a href="{% url 'inicio' %}">Inicio</a></li>
        <li class="breadcrumb-item active">Editar Producto</li>
    </ol>
    <h1 class="page-header">Editar Producto</h1>
{% endblock %}

{% block contenido %}
    <div class="panel panel-inverse">
        <div class="panel-heading">
            <h4 class="panel-title">Editar Producto</h4>
        </div>
        <div class="panel-body">
            <!-- Mostrar mensajes de éxito/error -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-dismissible fade show alert-{{ message.tags }} shadow-sm mb-4">
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        <strong>{{ message|capfirst }}</strong> <!-- Capitaliza el mensaje -->
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Formulario para edición de producto -->
            <form method="POST" action="{% url 'editar_producto' producto.pk %}" id="producto-form">
                {% csrf_token %}
                
                <div class="row">
                    <!-- Código Generado (Solo lectura) -->
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            {{ form.codigo_generado.label_tag }}
                            {{ form.codigo_generado }}
                            {% if form.codigo_generado.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.codigo_generado.errors|striptags }}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">Código actual: {{ producto.codigo }}</small>
                        </div>
                    </div>

                    <!-- Línea -->
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            {{ form.linea.label_tag }}
                            {{ form.linea }}
                            {% if form.linea.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.linea.errors|striptags }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Sublínea -->
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            {{ form.sublinea.label_tag }}
                            {{ form.sublinea }}
                            {% if form.sublinea.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.sublinea.errors|striptags }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Clase -->
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            {{ form.clase.label_tag }}
                            {{ form.clase }}
                            {% if form.clase.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.clase.errors|striptags }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Material -->
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            {{ form.material.label_tag }}
                            {{ form.material }}
                            {% if form.material.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.material.errors|striptags }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Tipo de Producto -->
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            {{ form.tipo_producto.label_tag }}
                            {{ form.tipo_producto }}
                            {% if form.tipo_producto.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.tipo_producto.errors|striptags }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Marca -->
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            {{ form.marca.label_tag }}
                            {{ form.marca }}
                            {% if form.marca.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.marca.errors|striptags }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Modelo -->
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            {{ form.modelo.label_tag }}
                            {{ form.modelo }}
                            {% if form.modelo.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.modelo.errors|striptags }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Precio -->
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            {{ form.precio.label_tag }}
                            {{ form.precio }}
                            {% if form.precio.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.precio.errors|striptags }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Nombre (Opcional) -->
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            {{ form.nombre.label_tag }}
                            {{ form.nombre }}
                            {% if form.nombre.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.nombre.errors|striptags }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Descripción (Opcional) -->
                <div class="form-group mb-4">
                    {{ form.descripcion.label_tag }}
                    {{ form.descripcion }}
                    {% if form.descripcion.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.descripcion.errors|striptags }}
                        </div>
                    {% endif %}
                </div>

                <!-- Botón de actualización -->
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" id="submit-btn">Actualizar Producto</button>
                    <a href="{% url 'lista_productos' %}" class="btn btn-secondary">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        function actualizarCodigo() {
            const linea = document.getElementById('id_linea').value;
            const sublinea = document.getElementById('id_sublinea').value;
            const clase = document.getElementById('id_clase').value;
            
            if (linea && sublinea && clase) {
                const codigo = linea + sublinea + clase;
                document.getElementById('id_codigo_generado').value = codigo;
            } else {
                document.getElementById('id_codigo_generado').value = '';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar el código al cargar la página
            actualizarCodigo();
            
            // Agregar event listeners para actualizar el código
            ['id_linea', 'id_sublinea', 'id_clase'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', actualizarCodigo);
                }
            });
            
            // Convertir marca y modelo a mayúsculas automáticamente
            ['id_marca', 'id_modelo'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', function() {
                        this.value = this.value.toUpperCase();
                    });
                }
            });
        });
    </script>
{% endblock %}
