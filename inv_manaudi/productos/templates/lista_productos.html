{% extends 'base.html' %}
{% load static %}

{% block title %}Lista de Productos{% endblock %}

{% block extra_css %}
    <link href="{% static 'plugins/datatables.net-bs5/css/dataTables.bootstrap5.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'plugins/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'plugins/datatables.net-buttons-bs5/css/buttons.bootstrap5.min.css' %}" rel="stylesheet"/>
{% endblock %}

{% block encabezado %}
<ol class="breadcrumb float-xl-end">
    <li class="breadcrumb-item"><a href="{% url 'inicio' %}">Inicio</a></li>
    <li class="breadcrumb-item active">Lista de Productos</li>
</ol>
<h1 class="page-header">Lista de Productos - {{ empresa_actual.nombre }}</h1>
{% endblock %}

{% block contenido %}
<div class="panel panel-inverse">
    <div class="panel-heading">
        <h4 class="panel-title">Lista de Productos</h4>
        <div class="panel-heading-btn">
            <a href="{% url 'crear_producto' %}" class="btn btn-xs btn-success">
                <i class="fa fa-plus"></i> Nuevo Producto
            </a>
        </div>
    </div>
    <div class="panel-body">
        <table id="tabla-productos" class="table table-striped table-bordered align-middle">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Código Aux.</th>
                    <th>Código EAN</th>
                    <th>Modelo</th>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Precio</th>
                    <th>Tipo</th>
                    <th>Clasificación</th>
                    <th>Estado</th>
                    <th data-orderable="false">Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Los datos se cargarán via AJAX -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'plugins/datatables.net/js/dataTables.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-responsive/js/dataTables.responsive.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/dataTables.buttons.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.colVis.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.flash.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.html5.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.print.js' %}"></script>
    <script src="{% static 'plugins/pdfmake/build/pdfmake.js' %}"></script>
    <script src="{% static 'plugins/pdfmake/build/vfs_fonts.js' %}"></script>
    <script src="{% static 'plugins/jszip/dist/jszip.js' %}"></script>
    <script>
        $(document).ready(function () {
            $('#tabla-productos').DataTable({
                // Server-side processing
                processing: true,
                serverSide: true,
                ajax: {
                    url: "{% url 'lista_productos' %}",
                    type: 'GET',
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
                    },
                    error: function(xhr, error, thrown) {
                        console.error('Error en AJAX:', error, thrown);
                        console.log('Respuesta:', xhr.responseText);
                    },
                    dataSrc: function(json) {
                        console.log('Respuesta del servidor:', json);
                        return json.data;
                    }
                },
                // Configuración de columnas
                columns: [
                    { data: 0 },  // Código
                    { data: 1 },  // Código Auxiliar
                    { data: 2 },  // Código EAN
                    { data: 3 },  // Modelo
                    { data: 4 },  // Nombre
                    { data: 5 },  // Descripción
                    { data: 6 },  // Precio
                    { data: 7 },  // Tipo
                    { data: 8 },  // Clasificación
                    { data: 9 },  // Estado (con HTML)
                    { data: 10 }  // Acciones (con HTML)
                ],
                // Columnas con HTML
                columnDefs: [
                    {
                        targets: [9, 10],  // Estado y Acciones
                        orderable: false,
                        searchable: false
                    }
                ],
                // Dom structure con botones
                dom: '<"row mb-3"<"col-md-6"B><"col-md-6"fr>>t<"row mt-3"<"col-md-auto me-md-auto"i><"col-md-auto ms-md-auto"p>>',
                buttons: [
                    { 
                        extend: 'copy', 
                        className: 'btn-sm',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6, 7, 8]  // Excluir Estado y Acciones
                        }
                    },
                    { 
                        extend: 'csv', 
                        className: 'btn-sm',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6, 7, 8]
                        }
                    },
                    { 
                        extend: 'excel', 
                        className: 'btn-sm',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6, 7, 8]
                        }
                    },
                    { 
                        extend: 'pdf', 
                        className: 'btn-sm',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6, 7, 8]
                        }
                    },
                    { 
                        extend: 'print', 
                        className: 'btn-sm',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6, 7, 8]
                        }
                    }
                ],
                // Configuración de paginación
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
                // Idioma en español
                language: {
                    "lengthMenu": "Mostrar _MENU_ entradas",
                    "zeroRecords": "No se encontraron registros",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                    "infoEmpty": "Mostrando 0 a 0 de 0 entradas",
                    "infoFiltered": "(filtrado de _MAX_ entradas totales)",
                    "search": "Buscar:",
                    "paginate": {
                        "first": "Primero",
                        "last": "Último",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    },
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "emptyTable": "No hay datos disponibles en la tabla",
                    "aria": {
                        "sortAscending": ": activar para ordenar la columna de manera ascendente",
                        "sortDescending": ": activar para ordenar la columna de manera descendente"
                    }
                },
                // Configuración adicional
                responsive: true,
                order: [[0, 'asc']],  // Ordenar por código por defecto
                // Renderizar HTML en columnas específicas
                createdRow: function(row, data, dataIndex) {
                    // Las celdas de Estado y Acciones ya vienen con HTML
                    $('td:eq(9)', row).html(data[9]);  // Estado
                    $('td:eq(10)', row).html(data[10]);  // Acciones
                }
            });
        });
    </script>
{% endblock %}
