{% extends 'base.html' %}
{% load static %}

{% block title %}Reporte de Movimientos del Día{% endblock %}

{% block extra_css %}
    <link href="{% static 'plugins/datatables.net-bs5/css/dataTables.bootstrap5.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'plugins/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'plugins/datatables.net-buttons-bs5/css/buttons.bootstrap5.min.css' %}" rel="stylesheet"/>
{% endblock %}

{% block encabezado %}
<ol class="breadcrumb float-xl-end">
    <li class="breadcrumb-item"><a href="{% url 'inicio' %}">Inicio</a></li>
    <li class="breadcrumb-item"><a href="#">Reportes</a></li>
    <li class="breadcrumb-item active">Movimientos del Día</li>
</ol>
<h1 class="page-header">Reporte de Movimientos del Día</h1>
{% endblock %}

{% block contenido %}
<div class="panel panel-inverse">
    <div class="panel-heading">
        <h4 class="panel-title">
            <i class="fa fa-calendar-day"></i> Movimientos del {{ fecha_hoy|date:"d/m/Y" }} - {{ empresa.nombre }}
        </h4>
        <div class="panel-heading-btn">
            <a href="javascript:;" class="btn btn-xs btn-icon btn-default" data-toggle="panel-expand"><i class="fa fa-expand"></i></a>
            <a href="javascript:;" class="btn btn-xs btn-icon btn-success" onclick="window.print()"><i class="fa fa-print"></i></a>
        </div>
    </div>
    <div class="panel-body">
        <!-- Tarjetas de Resumen Superior -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="widget widget-stats bg-primary">
                    <div class="stats-icon"><i class="fa fa-users"></i></div>
                    <div class="stats-info">
                        <h4>USUARIOS ACTIVOS</h4>
                        <p class="fs-2">{{ resumen_por_usuario|length }}</p>
                        <small>Realizaron movimientos hoy</small>
                    </div>
                </div>
            </div>
            
            {% for tipo in resumen_por_tipo %}
            <div class="col-xl-3 col-md-6">
                <div class="widget widget-stats {% if tipo.tipo_movimiento == 'entrada' %}bg-success{% else %}bg-danger{% endif %}">
                    <div class="stats-icon">
                        <i class="fa {% if tipo.tipo_movimiento == 'entrada' %}fa-plus-circle{% else %}fa-minus-circle{% endif %}"></i>
                    </div>
                    <div class="stats-info">
                        <h4>{{ tipo.tipo_movimiento|upper }}S</h4>
                        <p class="fs-2">{{ tipo.total_cantidad }}</p>
                        <small>{{ tipo.total_movimientos }} movimientos</small>
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <div class="col-xl-3 col-md-6">
                <div class="widget widget-stats bg-info">
                    <div class="stats-icon"><i class="fa fa-exchange-alt"></i></div>
                    <div class="stats-info">
                        <h4>TOTAL MOVIMIENTOS</h4>
                        <p class="fs-2">{{ detalles_movimientos|length }}</p>
                        <small>Registrados hoy</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs para diferentes vistas -->
        <ul class="nav nav-tabs mb-3" id="reporteTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="detalle-tab" data-bs-toggle="tab" data-bs-target="#detalle" type="button" role="tab">
                    <i class="fa fa-list"></i> Detalle de Movimientos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="usuario-tab" data-bs-toggle="tab" data-bs-target="#usuario" type="button" role="tab">
                    <i class="fa fa-user"></i> Resumen por Usuario
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tipo-tab" data-bs-toggle="tab" data-bs-target="#tipo" type="button" role="tab">
                    <i class="fa fa-chart-pie"></i> Resumen por Tipo
                </button>
            </li>
        </ul>

        <div class="tab-content" id="reporteTabContent">
            <!-- Tab de Detalle -->
            <div class="tab-pane fade show active" id="detalle" role="tabpanel">
                <div class="table-responsive">
                    <table id="tabla-movimientos" class="table table-striped table-bordered align-middle">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Producto</th>
                                <th>Tipo</th>
                                <th>Cantidad</th>
                                <th>Sucursal</th>
                                <th>Usuario</th>
                                <th>Documento</th>
                                <th>Comentario</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for movimiento in detalles_movimientos %}
                            <tr>
                                <td data-order="{{ movimiento.fecha|date:'YmdHis' }}">
                                    {{ movimiento.fecha|date:"H:i:s" }}
                                </td>
                                <td>
                                    <strong>{{ movimiento.producto.codigo }}</strong><br>
                                    <small class="text-muted">{{ movimiento.producto.nombre }}</small>
                                </td>
                                <td class="text-center">
                                    {% if movimiento.tipo_movimiento == 'entrada' %}
                                        <span class="badge bg-success">
                                            <i class="fa fa-plus"></i> ENTRADA
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fa fa-minus"></i> SALIDA
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <span class="fs-5 fw-bold">{{ movimiento.cantidad }}</span>
                                </td>
                                <td>{{ movimiento.sucursal.nombre }}</td>
                                <td>
                                    {% if movimiento.usuario %}
                                        {{ movimiento.usuario.get_full_name|default:movimiento.usuario.username }}
                                    {% else %}
                                        <span class="text-muted">Sin usuario</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if movimiento.tipo_documento %}
                                        <small>
                                            {{ movimiento.get_tipo_documento_display }}<br>
                                            #{{ movimiento.documento_respaldo }}
                                        </small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ movimiento.comentario|default:"Sin comentarios" }}</small>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    <i class="fa fa-info-circle"></i> No hay movimientos registrados hoy
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab de Resumen por Usuario -->
            <div class="tab-pane fade" id="usuario" role="tabpanel">
                <div class="row">
                    {% for usuario in resumen_por_usuario %}
                    <div class="col-xl-4 col-md-6 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                            <i class="fa fa-user fa-2x text-primary"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h5 class="mb-1">{{ usuario.usuario__username|capfirst }}</h5>
                                        <div class="text-muted small">
                                            <i class="fa fa-box"></i> {{ usuario.total_movimientos }} movimientos
                                        </div>
                                        <div class="text-primary fw-bold">
                                            <i class="fa fa-cubes"></i> {{ usuario.total_cantidad }} unidades
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fa fa-info-circle"></i> No hay actividad de usuarios registrada hoy
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Tab de Resumen por Tipo -->
            <div class="tab-pane fade" id="tipo" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Tipo de Movimiento</th>
                                        <th class="text-center">Cantidad de Movimientos</th>
                                        <th class="text-center">Total Unidades</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tipo in resumen_por_tipo %}
                                    <tr>
                                        <td>
                                            {% if tipo.tipo_movimiento == 'entrada' %}
                                                <span class="badge bg-success me-2">
                                                    <i class="fa fa-plus"></i>
                                                </span>
                                            {% else %}
                                                <span class="badge bg-danger me-2">
                                                    <i class="fa fa-minus"></i>
                                                </span>
                                            {% endif %}
                                            {{ tipo.tipo_movimiento|capfirst }}
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-secondary fs-6">{{ tipo.total_movimientos }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="fw-bold fs-5">{{ tipo.total_cantidad }}</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                {% if resumen_por_tipo %}
                                <tfoot class="table-light">
                                    <tr>
                                        <th>Balance del día</th>
                                        <th class="text-center">
                                            {% with total_mov=resumen_por_tipo|length %}
                                                <span class="badge bg-info fs-6">{{ detalles_movimientos|length }}</span>
                                            {% endwith %}
                                        </th>
                                        <th class="text-center">
                                            {% with entrada=resumen_por_tipo.0.total_cantidad|default:0 salida=resumen_por_tipo.1.total_cantidad|default:0 %}
                                                {% if resumen_por_tipo.0.tipo_movimiento == 'salida' %}
                                                    {% with temp=entrada entrada=salida salida=temp %}
                                                    {% endwith %}
                                                {% endif %}
                                                <span class="fw-bold fs-5 {% if entrada > salida %}text-success{% elif entrada < salida %}text-danger{% else %}text-secondary{% endif %}">
                                                    {{ entrada|add:salida|floatformat:0 }}
                                                </span>
                                            {% endwith %}
                                        </th>
                                    </tr>
                                </tfoot>
                                {% endif %}
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'plugins/datatables.net/js/dataTables.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-bs5/js/dataTables.bootstrap5.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-responsive/js/dataTables.responsive.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-responsive-bs5/js/responsive.bootstrap5.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons-bs5/js/buttons.bootstrap5.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.colVis.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.html5.min.js' %}"></script>
    <script src="{% static 'plugins/datatables.net-buttons/js/buttons.print.min.js' %}"></script>
    <script src="{% static 'plugins/pdfmake/build/pdfmake.min.js' %}"></script>
    <script src="{% static 'plugins/pdfmake/build/vfs_fonts.min.js' %}"></script>
    <script src="{% static 'plugins/jszip/dist/jszip.min.js' %}"></script>
    <script>
        $(document).ready(function() {
            // Inicializar DataTable
            $('#tabla-movimientos').DataTable({
                responsive: true,
                order: [[0, 'desc']],
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
                dom: '<"row mb-3"<"col-md-6"B><"col-md-6"fr>>t<"row mt-3"<"col-md-auto me-md-auto"i><"col-md-auto ms-md-auto"p>>',
                buttons: [
                    {
                        extend: 'copy',
                        className: 'btn-sm',
                        text: '<i class="fa fa-copy"></i> Copiar'
                    },
                    {
                        extend: 'csv',
                        className: 'btn-sm',
                        text: '<i class="fa fa-file-csv"></i> CSV'
                    },
                    {
                        extend: 'excel',
                        className: 'btn-sm',
                        text: '<i class="fa fa-file-excel"></i> Excel'
                    },
                    {
                        extend: 'pdf',
                        className: 'btn-sm',
                        text: '<i class="fa fa-file-pdf"></i> PDF',
                        orientation: 'landscape'
                    },
                    {
                        extend: 'print',
                        className: 'btn-sm',
                        text: '<i class="fa fa-print"></i> Imprimir'
                    }
                ],
                language: {
                    "lengthMenu": "Mostrar _MENU_ registros",
                    "zeroRecords": "No se encontraron registros",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
                    "infoEmpty": "Mostrando 0 a 0 de 0 registros",
                    "infoFiltered": "(filtrado de _MAX_ registros totales)",
                    "search": "Buscar:",
                    "paginate": {
                        "first": "Primero",
                        "last": "Último",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    },
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando..."
                }
            });
        });
    </script>
{% endblock %}