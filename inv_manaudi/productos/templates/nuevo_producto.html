{% extends 'base.html' %}
{% load static %}

{% block title %}Nuevo Producto Óptica{% endblock %}

{% block encabezado %}
<ol class="breadcrumb float-xl-end">
    <li class="breadcrumb-item"><a href="{% url 'inicio' %}">Inicio</a></li>
    <li class="breadcrumb-item active">Nuevo Producto Óptica</li>
</ol>
<h1 class="page-header">Nuevo Producto Óptica</h1>
{% endblock %}

{% block contenido %}
    <div class="panel panel-inverse">
        <div class="panel-heading">
            <h4 class="panel-title">Nuevo Producto Óptica - Generación Automática de Código</h4>
        </div>
        <div class="panel-body">
           <!-- Mostrar mensajes de éxito/error -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-dismissible fade show alert-{{ message.tags }} shadow-sm mb-4">
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        <strong>{{ message|capfirst }}</strong>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Formulario para creación de producto -->
            <form method="POST" action="{% url 'crear_producto' %}" id="producto-form">
                {% csrf_token %}
                
                <!-- Código generado automáticamente -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <h5>Código Generado: <span id="codigo-display" class="badge bg-primary fs-6">------</span></h5>
                        </div>
                    </div>
                </div>

                <!-- Primera fila: Características para generar código -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label for="id_linea" class="form-label fw-bold">Línea *</label>
                            {{ form.linea }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label for="id_sublinea" class="form-label fw-bold">Sublínea *</label>
                            {{ form.sublinea }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label for="id_clase" class="form-label fw-bold">Clase *</label>
                            {{ form.clase }}
                        </div>
                    </div>
                </div>

                <!-- Segunda fila: Marca y Modelo -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="id_marca" class="form-label fw-bold">Marca *</label>
                            {{ form.marca }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="id_modelo" class="form-label fw-bold">Modelo *</label>
                            {{ form.modelo }}
                        </div>
                    </div>
                </div>

                <!-- Tercera fila: Precio, Tipo y Material -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label for="id_precio" class="form-label fw-bold">Precio *</label>
                            {{ form.precio }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label for="id_tipo_producto" class="form-label fw-bold">Tipo *</label>
                            {{ form.tipo_producto }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label for="id_material" class="form-label">Material</label>
                            {{ form.material }}
                        </div>
                    </div>
                </div>

                <!-- Cuarta fila: Campos opcionales -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="id_nombre" class="form-label">Nombre (Opcional)</label>
                            {{ form.nombre }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="id_descripcion" class="form-label">Descripción (Opcional)</label>
                            {{ form.descripcion }}
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                            <i class="fa fa-save"></i> Crear Producto
                        </button>
                        <a href="{% url 'lista_productos' %}" class="btn btn-secondary btn-lg">
                            <i class="fa fa-times"></i> Cancelar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script>
        $(document).ready(function(){
            // Máscara para el precio
            $('#id_precio').mask('00000000.00', {
                reverse: true,
                placeholder: "0.00"
            });
            
            // Función para actualizar el código generado
            function actualizarCodigo() {
                var linea = $('#id_linea').val();
                var sublinea = $('#id_sublinea').val();
                var clase = $('#id_clase').val();
                
                if (linea && sublinea && clase) {
                    var codigo = linea + sublinea + clase;
                    $('#codigo-display').text(codigo);
                    $('#codigo-display').removeClass('bg-secondary').addClass('bg-success');
                } else {
                    $('#codigo-display').text('------');
                    $('#codigo-display').removeClass('bg-success').addClass('bg-secondary');
                }
            }
            
            // Actualizar código cuando cambien los selectores
            $('#id_linea, #id_sublinea, #id_clase').on('change', actualizarCodigo);
            
            // Convertir texto a mayúsculas automáticamente
            $('#id_marca, #id_modelo').on('input', function() {
                this.value = this.value.toUpperCase();
            });
            
            // También para campos opcionales
            $('#id_nombre, #id_descripcion').on('input', function() {
                this.value = this.value.toUpperCase();
            });
            
            // Actualizar código al cargar la página (por si viene con datos)
            actualizarCodigo();
        });
    </script>
{% endblock %}

