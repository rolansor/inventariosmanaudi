{% extends 'base.html' %}
{% load static %}
{% load tags %}

{% block title %}Buscar Productos{% endblock %}

{% block contenido %}
<div class="panel panel-inverse">
    <div class="panel-heading">
        <h4 class="panel-title">Buscar Productos</h4>
    </div>
    <div class="panel-body">
        <form method="GET" action="{% url 'busqueda_producto' %}">
            <div class="row">
                <!-- Filtro por línea -->
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="linea">Línea</label>
                        <select id="linea" name="linea" class="form-control">
                            <option value="">Todas</option>
                            {% for value, display in linea_choices %}
                                <option value="{{ value }}" {% if linea_selected == value %}selected{% endif %}>
                                    {{ display }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Filtro por sublínea -->
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="sublinea">Sublínea</label>
                        <select id="sublinea" name="sublinea" class="form-control">
                            <option value="">Todas</option>
                            {% for value, display in sublinea_choices %}
                                <option value="{{ value }}" {% if sublinea_selected == value %}selected{% endif %}>
                                    {{ display }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Filtro por clase -->
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="clase">Clase</label>
                        <select id="clase" name="clase" class="form-control">
                            <option value="">Todas</option>
                            {% for value, display in clase_choices %}
                                <option value="{{ value }}" {% if clase_selected == value %}selected{% endif %}>
                                    {{ display }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Botón de búsqueda -->
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">Buscar</button>
                    <a href="{% url 'busqueda_producto' %}" class="btn btn-secondary">Limpiar</a>
                </div>
            </div>
        </form>

        <!-- Mostrar resultados filtrados -->
        <table class="table table-striped table-bordered mt-4">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Precio</th>
                    <th>Tipo</th>
                    <th>Categoría/Subcategoria</th>
                    <th>Empresa</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for producto in productos %}
                    <tr>
                        <td>{{ producto.codigo }}</td>
                        <td>{{ producto.nombre }}</td>
                        <td>{{ producto.descripcion|default:"Sin descripción" }}</td>
                        <td>{{ producto.precio }}</td>
                        <td>{{ producto.get_tipo_producto_display }}</td>
                        <td>{{ producto.categoria.categoria.nombre }} -- {{ producto.categoria.nombre }}</td>
                        <td>{{ producto.empresa.nombre }}</td>
                        <td>
                            {% if request.user|pertenece_grupo:"Supervisor" %}
                            <a href="{% url 'editar_producto' producto.pk %}" class="btn btn-info">Editar Producto</a>{% endif %}
                            {% if request.user|pertenece_grupo:"Manaudi" %}
                            <a href="{% url 'eliminar_producto' producto.pk %}" class="btn btn-danger">Eliminar Producto</a>{% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="8" class="text-center">No se encontraron productos con los criterios de búsqueda.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
